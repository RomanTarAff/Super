name: API

on:
  workflow_call:
    inputs:
      environment:
        description: Environment
        required: true
        type: string

env:
  RP_RUN_ID: api-${{ github.run_id }}
  HOST: ${{ inputs.environment }}

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
    - uses: actions/setup-node@v3
      with:
        node-version: 16
    - name: NPM
      working-directory: AQA/node
      run: npm install
    - name: Run UI tests
      working-directory: AQA/java
      run: xvfb-run --auto-servernum mvn clean test -Papi -q -DsuiteXmlFile=api -Dhost=${{ env.HOST }} -Drp.launch=API -Drp.attributes="id:$RP_RUN_ID;env:$HOST;tag:API"
      env:
        JOB_NAME: API tests on ${{ env.HOST }}

    - name: Allure Report
      uses: simple-elf/allure-report-action@master
      if: always()
      id: allure-report
      with:
        allure_results: AQA/java/allure-results
        gh_pages: gh-pages
        allure_report: allure-report
        allure_history: allure-history

    - name: Deploy Allure report to Github Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v2
      env:
        PERSONAL_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PUBLISH_BRANCH: feat/SFRU-7190
        PUBLISH_DIR: allure-history

    - name: Post the link to the report
      if: always()
      uses: Sibz/github-status-action@v1
      with:
          authToken: ${{secrets.GITHUB_TOKEN}}
          context: 'Test report'
          state: 'success'
          target_url: https://allure.rmr-t.ru/github-allure-history/${{ github.run_number }}

  notify:
    name: Slack Notification
    runs-on: ubuntu-latest
    needs: [ report ]
    timeout-minutes: 3
    if: always()
    steps:
    - name: Slack Notification
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_USERNAME: 'API'
        #SLACK_ICON_EMOJI: 'ðŸŸ¢'
        SLACK_TITLE: API on ${{ env.HOST }}
        SLACK_MESSAGE: ${{ needs.report.outputs.passed }} of ${{ needs.report.outputs.total }} passed - https://report-portal.rmr-t.ru/ui/#superfarm/launches/all/${{ needs.report.outputs.launchID }}
        SLACK_FOOTER: ''
        SLACK_COLOR: success
        SLACK_WEBHOOK: 'https://hooks.slack.com/services/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'