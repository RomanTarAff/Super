name: Selenoid

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment
        required: true
        type: choice
        options:
          - develop
          - test

env:
  RP_RUN_ID: api-${{ github.run_id }}
  HOST: ${{ inputs.environment }}
  TEST_SET: ${{ inputs.testSet }}

jobs:
  tests:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: docker-practice/actions-setup-docker@master
    - run: |
        docker pull selenoid/chrome:latest
    - run: |
        docker run -d                                   \
        --name selenoid                                 \
        -p 4444:4444                                    \
        -v /var/run/docker.sock:/var/run/docker.sock    \
        -v /your/directory/config/:/etc/selenoid/:ro    \
        aerokube/selenoid:latest-release
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
    - uses: actions/setup-node@v3
      with:
        node-version: 16
    - name: NPM
      working-directory: AQA/node
      run: npm install
    - name: Run UI tests
      working-directory: AQA/java
      run: xvfb-run --auto-servernum mvn clean test -Pui -q -DsuiteXmlFile=listing -Dhost=${{ env.HOST }} -Drp.launch=Listing
      env:
        JOB_NAME: UI tests on ${{ inputs.environment }}

    - name: Get test launch with label ${{ env.RP_RUN_ID }}
      id: getTestLaunch
      uses: fjogeleit/http-request-action@master
      if: always()
      with:
        url: https://report-portal.rmr-t.ru/api/v1/superfarm/launch?filter.has.attributeKey=runID&filter.has.attributeValue=${{ env.RP_RUN_ID }}
        method: 'GET'
        bearerToken: '830c1494-2c9c-4b3f-8cb8-29e54a84d2e0'

    - name: Extract ID of the launch ${{ env.RP_RUN_ID }}
      id: extractReportID
      if: always()
      run: |
        echo ${{ steps.getTestLaunch.outputs.response }}
        echo "::set-output name=launchID::$(echo '${{ steps.getTestLaunch.outputs.response }}' | jq .content[].id)"
        echo "::set-output name=status::$(echo '${{ steps.getTestLaunch.outputs.response }}' | jq .content[].status)"
        echo "::set-output name=passed::$(echo '${{ steps.getTestLaunch.outputs.response }}' | jq .content[].statistics.executions.passed)"
        echo "::set-output name=total::$(echo '${{ steps.getTestLaunch.outputs.response }}' | jq .content[].statistics.executions.total)"
        echo "::set-output name=failed::$(echo '${{ steps.getTestLaunch.outputs.response }}' | jq .content[].statistics.executions.failed)"

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: screenshots
        path: 'AQA/java/screenshots'